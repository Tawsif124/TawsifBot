<!DOCTYPE html>
<html lang="bn">
<head>
    <link rel="icon" href="logo.jpg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-image: url('kola.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: background-image 0.5s ease;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bg-overlay {
            background-color: rgba(0, 0, 0, 0.4);
        }

        .typewriter-text {
            overflow: hidden;
            border-right: .15em solid orange;
            white-space: nowrap;
            animation: 
                typing 2.5s steps(20, end),
                blink-caret .75s step-end infinite;
            display: inline-block;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: orange }
        }

        .animated-btn {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .animated-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }

        #style-options {
            position: absolute;
            top: 60px;
            right: 0;
            transform: translateX(0);
            z-index: 10;
        }
        
        .chat-container {
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            @media (min-width: 768px) {
                max-width: 500px;
                max-height: 700px;
                border-radius: 2rem;
            }
            @media (min-width: 1024px) {
                 max-width: 600px;
                 max-height: 800px;
            }
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 1.5rem;
            color: #aaa;
        }

        /* Custom styles for Markdown-rendered content */
        .markdown-content p {
            margin-bottom: 1rem;
        }
        .markdown-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .markdown-content ol {
            list-style-type: decimal;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .markdown-content li {
            margin-bottom: 0.5rem;
        }
        .markdown-content strong {
            font-weight: 700;
        }
        .markdown-content em {
            font-style: italic;
        }

        /* New styles for the selection toolbar */
        #selection-toolbar {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            z-index: 20;
            cursor: pointer;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        #selection-toolbar:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-overlay">
    <div id="main-container" class="flex items-center justify-center transition-all duration-300 w-full h-full">
        <div id="chat-box" class="chat-container relative bg-white bg-opacity-90 backdrop-filter backdrop-blur-sm shadow-xl flex flex-col transition-all duration-300">
             <button id="menu-toggle-btn" class="absolute top-4 left-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 z-10">
                <svg id="menu-arrow-icon" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <div class="border-b border-gray-200 pb-4 mb-4 flex justify-center items-center relative px-10 pt-4">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <span id="chat-title" class="typewriter-text"></span>
                    <button id="style-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-semibold py-1 px-2 rounded-full animated-btn">
                        স্টাইল
                    </button>
                </h1>
                <select id="language-select" class="absolute right-4 rounded-full border border-gray-300 px-4 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="bn-BD">বাংলা</option>
                    <option value="en-US">English</option>
                    <option value="hi-IN">हिन्दी</option>
                    <option value="es-ES">Español</option>
                </select>
            </div>
            <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 pr-2 pl-4 md:pl-8">
                <div class="flex items-start gap-2.5">
                    <div class="flex flex-col w-full max-w-[320px] leading-1.5 p-4 border-gray-200 bg-gray-100 rounded-e-xl rounded-es-xl">
                        <p class="text-sm font-normal text-gray-900">আমি স্টাডি চ্যাটবট, আমি কিভাবে তোমাকে সাহায্য করতে পারি?</p>
                    </div>
                </div>
            </div>
            <div id="loading-spinner" class="hidden text-center my-4">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <div class="mt-4 px-4 pb-4">
                <form id="chat-form" class="flex gap-2">
                    <input
                        type="text"
                        id="user-input"
                        class="flex-grow rounded-full border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="মেসেজ লিখ..."
                        autocomplete="off"
                        required
                    />
                    <button
                        type="button"
                        id="voice-input-btn"
                        class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                        <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M7 4a3 3 0 00-3 3v6a3 3 0 006 0V7a3 3 0 00-3-3zM3 7a5 5 0 0110 0v6a5 5 0 01-10 0V7zm4-4a1 1 0 011 1v1a1 1 0 11-2 0V4a1 1 0 011-1zm0 14a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button
                        type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    >
                        পাঠাও
                    </button>
                </form>
            </div>
            <div id="style-options" class="hidden bg-white rounded-2xl p-6 shadow-xl space-y-4 max-w-xs w-full transition-all duration-300">
                <h3 class="text-lg font-bold text-gray-800">স্টাইল অপশন</h3>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">রঙিন টেক্সট</span>
                    <button id="text-color-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-state="off">
                        <span class="sr-only">রঙিন টেক্সট অন/অফ</span>
                        <span class="transform transition-transform duration-200 bg-gray-200 inline-block h-5 w-5 rounded-full" data-state="off"></span>
                    </button>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">রঙিন ব্যাকগ্রাউন্ড</span>
                    <button id="bg-color-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-state="off">
                        <span class="sr-only">ব্যাকগ্রাউন্ড অন/অফ</span>
                        <span class="transform transition-transform duration-200 bg-gray-200 inline-block h-5 w-5 rounded-full" data-state="off"></span>
                    </button>
                </div>
            </div>
        </div>
        <!-- Updated Sidebar Menu with links -->
        <div id="sidebar-menu" class="fixed top-0 left-0 h-full w-64 bg-white bg-opacity-90 backdrop-filter backdrop-blur-sm shadow-xl p-6 flex flex-col items-center space-y-4 transition-transform duration-300 transform -translate-x-full z-20">
            <button id="close-menu-btn" class="self-end p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-xl font-bold text-gray-800 border-b-2 border-indigo-600 pb-2 mb-2">মেনু</h2>
            <button id="pdf-analyser-btn" class="w-full py-4 px-6 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-full animated-btn" data-url="pdf.html">
                <span class="text-2xl">📄</span> PDF Analyser
            </button>
            <button id="pic-analyser-btn" class="w-full py-4 px-6 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-full animated-btn" data-url="Pic.html">
                <span class="text-2xl">🖼️</span> Picture Analyser
            </button>
        </div>
    </div>
    <div id="about-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-btn">&times;</span>
            <h2 class="text-2xl font-bold mb-4">About Study Chatbot</h2>
            <p>This is a simple chatbot created by Tawsif. It uses the Gemini API to provide conversational responses and includes features like voice input and custom styles.</p>
        </div>
    </div>
    <!-- New selection toolbar for reply feature -->
    <div id="selection-toolbar" class="hidden">
        <button id="ask-chatbot-btn" class="flex items-center gap-2 p-2 text-sm font-medium rounded-md hover:bg-gray-700 transition-colors">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.971-4.029 9-9 9s-9-4.029-9-9 4.029-9 9-9 9 4.029 9 9z" />
            </svg>
            Ask Chatbot
        </button>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const loadingSpinner = document.getElementById('loading-spinner');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const languageSelect = document.getElementById('language-select');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const sidebarMenu = document.getElementById('sidebar-menu');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const chatTitle = document.getElementById('chat-title');
        const aboutModal = document.getElementById('about-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const styleBtn = document.getElementById('style-btn');
        const styleOptionsContainer = document.getElementById('style-options');
        const textColorToggle = document.getElementById('text-color-toggle');
        const bgColorToggle = document.getElementById('bg-color-toggle');
        const pdfAnalyserBtn = document.getElementById('pdf-analyser-btn');
        const picAnalyserBtn = document.getElementById('pic-analyser-btn');
        const body = document.body;
        
        // New elements for the selection feature
        const selectionToolbar = document.getElementById('selection-toolbar');
        const askChatbotBtn = document.getElementById('ask-chatbot-btn');
        
        const textColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6'];
        let isTextColored = false;
        let isBackgroundStyled = false;

        chatTitle.textContent = 'Study Chatbot 💬';

        closeModalBtn.addEventListener('click', () => {
            aboutModal.style.display = 'none';
        });

        styleBtn.addEventListener('click', () => {
            styleOptionsContainer.classList.toggle('hidden');
        });

        textColorToggle.addEventListener('click', () => {
            isTextColored = !isTextColored;
            textColorToggle.setAttribute('data-state', isTextColored ? 'on' : 'off');
            const toggleSpan = textColorToggle.querySelector('span:last-child');
            if (isTextColored) {
                textColorToggle.classList.add('bg-green-500');
                textColorToggle.classList.remove('bg-gray-200');
                toggleSpan.classList.add('translate-x-5', 'bg-white');
                toggleSpan.classList.remove('bg-gray-200');
            } else {
                textColorToggle.classList.remove('bg-green-500');
                textColorToggle.classList.add('bg-gray-200');
                toggleSpan.classList.remove('translate-x-5', 'bg-white');
                toggleSpan.classList.add('bg-gray-200');
            }
        });

        bgColorToggle.addEventListener('click', () => {
            isBackgroundStyled = !isBackgroundStyled;
            bgColorToggle.setAttribute('data-state', isBackgroundStyled ? 'on' : 'off');
            const toggleSpan = bgColorToggle.querySelector('span:last-child');
            if (isBackgroundStyled) {
                bgColorToggle.classList.add('bg-green-500');
                bgColorToggle.classList.remove('bg-gray-200');
                toggleSpan.classList.add('translate-x-5', 'bg-white');
                toggleSpan.classList.remove('bg-gray-200');
                body.style.backgroundImage = 'linear-gradient(45deg, #a855f7, #6366f1)';
            } else {
                bgColorToggle.classList.remove('bg-green-500');
                bgColorToggle.classList.add('bg-gray-200');
                toggleSpan.classList.remove('translate-x-5', 'bg-white');
                toggleSpan.classList.add('bg-gray-200');
                body.style.backgroundImage = 'url("https://placehold.co/1920x1080/2a2a2a/fff?text=Study+Chatbot")';
            }
        });

        menuToggleBtn.addEventListener('click', () => {
            sidebarMenu.classList.remove('-translate-x-full');
        });
        closeMenuBtn.addEventListener('click', () => {
            sidebarMenu.classList.add('-translate-x-full');
        });
        
        pdfAnalyserBtn.addEventListener('click', () => {
            window.location.href = pdfAnalyserBtn.dataset.url;
        });

        picAnalyserBtn.addEventListener('click', () => {
            window.location.href = picAnalyserBtn.dataset.url;
        });
        
        // Family information stored in an object for easy lookup
        // Added the new names as requested by the user.
        const familyInfo = {
            'puspo': 'তাওসীফের মা',
            'nigar': 'তাওসীফের মা',
            'tafazzal': 'তাওসীফের আব্বু',
            'sabuj': 'তাওসীফের আব্বু',
            'muaz': 'তাওসীফের ছোট্ট মামাতো ভাই',
            'jarif': 'তাওসীফের ছোট মামাতো ভাই',
            'munjir': 'তাওসীফের সবচেয়ে ছোট মামাতো ভাই',
            'trisha': 'তাওসীফের বোন',
            'rayhan': 'তাওসীফের দুলাভাই',
            'rekha': 'তাওসীফের নানু',
            'reja': 'তাওসীফের নানা',
        };
        
        let chatHistory = [{
            role: "model",
            parts: [{ text: "আমি স্টাডি চ্যাটবট, আমি কিভাবে তোমাকে সাহায্য করতে পারি?" }]
        }];
        
        // Removed hardcoded API key
        const apiKey = "AIzaSyBr5pug_OpHcoVccs0e6_tZB7GQPNVBf-E"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        function startSpeechRecognition() {
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = languageSelect.value;

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    chatForm.dispatchEvent(new Event('submit'));
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                };

                recognition.onend = () => {
                    voiceInputBtn.innerHTML = `<svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 00-3 3v6a3 3 0 006 0V7a3 3 0 00-3-3zM3 7a5 5 0 0110 0v6a5 5 0 01-10 0V7zm4-4a1 1 0 011 1v1a1 1 0 11-2 0V4a1 1 0 011-1zm0 14a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd" /></svg>`;
                };
            } else {
                console.warn('Speech Recognition is not supported by this browser.');
                voiceInputBtn.style.display = 'none';
            }
        }
        
        startSpeechRecognition();

        voiceInputBtn.addEventListener('click', () => {
            voiceInputBtn.innerHTML = `<svg class="h-6 w-6 animate-pulse" fill="red" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 00-3 3v6a3 3 0 006 0V7a3 3 0 00-3-3zM3 7a5 5 0 0110 0v6a5 5 0 01-10 0V7zm4-4a1 1 0 011 1v1a1 1 0 11-2 0V4a1 1 0 011-1zm0 14a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd" /></svg>`;
            if (recognition) {
                 recognition.start();
            }
        });

        languageSelect.addEventListener('change', () => {
            const selectedLanguage = languageSelect.options[languageSelect.selectedIndex].value;
            const placeholders = {
                'bn-BD': 'মেসেজ লিখ...',
                'en-US': 'Type your message...',
                'hi-IN': 'अपना संदेश लिखें...',
                'es-ES': 'Escribe tu mensaje...'
            };
            userInput.placeholder = placeholders[selectedLanguage];
            startSpeechRecognition();
        });
        
        // Event listener for the "Ask Chatbot" button
        askChatbotBtn.addEventListener('click', () => {
            const selectedText = window.getSelection().toString().trim();
            if (selectedText) {
                userInput.value = selectedText;
                chatForm.dispatchEvent(new Event('submit'));
                selectionToolbar.classList.add('hidden');
            }
        });
        
        // Event listener to show the toolbar when text is selected
        chatMessages.addEventListener('mouseup', (e) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            // Check if text is selected and if the selection is inside a model message
            if (selectedText && e.target.closest('.justify-start')) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();

                // Position the toolbar
                selectionToolbar.style.top = `${rect.top + window.scrollY - selectionToolbar.offsetHeight - 10}px`;
                selectionToolbar.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (selectionToolbar.offsetWidth / 2)}px`;
                selectionToolbar.classList.remove('hidden');
            } else {
                selectionToolbar.classList.add('hidden');
            }
        });

        // Event listener to hide the toolbar when a new selection is not made or click outside
        document.addEventListener('mousedown', (e) => {
            if (!selectionToolbar.contains(e.target)) {
                 selectionToolbar.classList.add('hidden');
            }
        });


        // Function to display a message with Markdown parsing
        async function displayMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-2.5 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = `flex flex-col w-full max-w-[320px] leading-1.5 p-4 ${sender === 'user' ? 'bg-indigo-600 rounded-e-xl rounded-es-xl text-white' : 'bg-gray-100 rounded-e-xl rounded-es-xl text-gray-900'} markdown-content`;

            if (sender === 'user') {
                messageContentDiv.innerHTML = `<p class="text-sm font-normal">${message}</p>`;
                messageDiv.appendChild(messageContentDiv);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                // For model, first append an empty paragraph
                const pTag = document.createElement('p');
                pTag.className = 'text-sm font-normal';
                messageContentDiv.appendChild(pTag);
                messageDiv.appendChild(messageContentDiv);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Now, perform the typewriter effect on the raw text
                await typewriterEffect(pTag, message);
                
                // After typing is complete, parse the Markdown and update the innerHTML
                const htmlContent = marked.parse(message);
                messageContentDiv.innerHTML = htmlContent;

                // Apply text colors to each paragraph, list item, and heading if the style is on
                if (isTextColored) {
                    const elementsToColor = messageContentDiv.querySelectorAll('p, ul, ol, h1, h2, h3, h4, h5, h6');
                    elementsToColor.forEach(el => {
                        const randomColor = textColors[Math.floor(Math.random() * textColors.length)];
                        el.style.color = randomColor;
                    });
                }
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function typewriterEffect(element, text, delay = 10) {
            let i = 0;
            return new Promise((resolve) => {
                const interval = setInterval(() => {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        i++;
                    } else {
                        clearInterval(interval);
                        resolve();
                    }
                }, delay);
            });
        }

        function displayQuizzes(quizzesData) {
            quizzesData.forEach((quizData, index) => {
                const quizContainer = document.createElement('div');
                quizContainer.className = 'w-full max-w-[400px] bg-gray-100 rounded-2xl p-4 my-4 animate-fadeIn';
                quizContainer.innerHTML = `
                    <h3 class="text-base font-bold text-gray-900 mb-4">${index + 1}. ${quizData.question}</h3>
                    <div class="space-y-2" id="options-container-${index}"></div>
                `;
                
                const optionsContainer = quizContainer.querySelector(`#options-container-${index}`);
                
                quizData.options.forEach((option) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.textContent = option;
                    optionBtn.className = 'w-full text-left py-2 px-4 rounded-full transition-colors duration-200 border border-gray-300 text-gray-700 hover:bg-gray-200';
                    optionBtn.dataset.option = option;
                    
                    optionBtn.addEventListener('click', () => {
                        const allButtons = optionsContainer.querySelectorAll('button');
                        allButtons.forEach(btn => {
                            btn.classList.remove('bg-indigo-500', 'text-white', 'bg-green-500', 'bg-red-500', 'border-transparent');
                            btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                        });
                        
                        optionBtn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                        optionBtn.classList.add('bg-indigo-500', 'text-white', 'border-transparent');

                        if (option === quizData.correctAnswer) {
                            setTimeout(() => {
                                optionBtn.classList.remove('bg-indigo-500');
                                optionBtn.classList.add('bg-green-500');
                            }, 500);
                        } else {
                            setTimeout(() => {
                                optionBtn.classList.remove('bg-indigo-500');
                                optionBtn.classList.add('bg-red-500');
                                const correctBtn = optionsContainer.querySelector(`[data-option="${quizData.correctAnswer}"]`);
                                if(correctBtn) {
                                    correctBtn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                                    correctBtn.classList.add('bg-green-500', 'text-white', 'border-transparent');
                                }
                            }, 500);
                        }
                    });
                    optionsContainer.appendChild(optionBtn);
                });
                chatMessages.appendChild(quizContainer);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        async function getGeminiResponse() {
            const userPrompt = chatHistory[chatHistory.length - 1].parts[0].text;
            const lowerPrompt = userPrompt.toLowerCase();
            const selectedLanguage = languageSelect.value;
            
            // Check for the new "add" command first
            const addCommandMatch = lowerPrompt.match(/^add:\s*(\S+)\s+is\s+(.*)/i);
            if (addCommandMatch) {
                const name = addCommandMatch[1].toLowerCase();
                const relationship = addCommandMatch[2].trim();
                familyInfo[name] = relationship;
                displayMessage(`${name.charAt(0).toUpperCase() + name.slice(1)} সম্পর্কে তোমার দেওয়া তথ্য আমি যোগ করে নিয়েছি।`, 'model');
                return;
            }

            const finalContents = JSON.parse(JSON.stringify(chatHistory));
            const lastMessageIndex = finalContents.length - 1;

            const creatorKeywords = ['tawsif', 'তাওসীফ', 'tawsifa', 'tausif', 'towsif', 'কে বানিয়েছে', 'কে তৈরি করেছে', 'কে তৈরি করছিস', 'তোর নির্মাতা কে', 'who made you', 'who created you', 'তোমার সম্পর্কে'];
            const quizKeywords = ['mcq', 'quiz', 'question', 'প্রশ্ন', 'কুইজ', 'বহুনির্বাচনি'];
            
            let payload;
            
            // Check for specific family queries using the dynamic list, now with the new '((name))' format
            let foundName = null;
            let foundRelationship = null;
            for (const name in familyInfo) {
                const nameRegex = new RegExp(`\\(\\(${name}\\)\\)`, 'i');
                if (nameRegex.test(lowerPrompt)) {
                    foundName = name;
                    foundRelationship = familyInfo[name];
                    break;
                }
            }

            if (foundName) {
                const conversationalPrompt = `${userPrompt}. You know that the person in question is ${foundRelationship}. Use this information to generate a helpful and friendly response in the language of the user's original query.`;
                finalContents[lastMessageIndex].parts[0].text = conversationalPrompt;
                payload = { contents: finalContents };
            } else if (quizKeywords.some(keyword => lowerPrompt.includes(keyword))) {
                let numQuizzes = 5;
                const numberWords = {
                    'এক': 1, 'দুই': 2, 'তিন': 3, 'চার': 4, 'পাঁচ': 5,
                    'ছয়': 6, 'সাত': 7, 'আট': 8, 'নয়': 9, 'দশ': 10,
                    'এগারো': 11, 'বারো': 12, 'তেরো': 13, 'চৌদ্দ': 14, 'পনেরো': 15,
                    'ষোল': 16, 'সতেরো': 17, 'আঠারো': 18, 'উনিশ': 19, 'বিশ': 20
                };
                
                const numbersInPrompt = userPrompt.match(/\d+|এক|দুই|তিন|চার|পাঁচ|ছয়|সাত|আট|নয়|দশ|এগারো|বারো|তেরো|চৌদ্দ|পনেরো|ষোল|সতেরো|আঠারো|উনিশ|বিশ/g);
                if (numbersInPrompt) {
                    const foundNumber = numbersInPrompt[0];
                    if (numberWords[foundNumber]) {
                        numQuizzes = numberWords[foundNumber];
                    } else if (!isNaN(parseInt(foundNumber))) {
                        numQuizzes = Math.min(parseInt(foundNumber), 20);
                    }
                }
                
                const quizPrompt = `Generate a JSON object containing an array of exactly ${numQuizzes} quiz questions on the topic "${userPrompt}". Each object in the array should have a "question" string, an "options" array of strings, and a "correctAnswer" string that matches one of the options. Ensure the JSON is well-formed. The questions should be in the user's selected language, which is ${selectedLanguage}.`;
                
                finalContents[lastMessageIndex].parts[0].text = quizPrompt;
                
                const quizSchema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING" },
                            "options": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" }
                            },
                            "correctAnswer": { "type": "STRING" }
                        },
                        "propertyOrdering": ["question", "options", "correctAnswer"]
                    }
                };
                
                payload = {
                    contents: finalContents,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: quizSchema
                    }
                };

            } else if (creatorKeywords.some(keyword => lowerPrompt.includes(keyword))) {
                let creatorPrompt;
                if (selectedLanguage === 'bn-BD') {
                    creatorPrompt = `${userPrompt}। তুই একজন চ্যাটবট, যাকে **তাওসীফ** তৈরি করেছে। তোর উত্তর বাংলাতে হবে, বন্ধুত্বপূর্ণ হবে এবং ইমোজি ব্যবহার করবে। তোর উত্তরে অবশ্যই **তাওসীফ** নামটি থাকবে।`;
                } else if (selectedLanguage === 'en-US') {
                    creatorPrompt = `${userPrompt}. You are a chatbot created by **Tawsif**. Your answer should be in English, friendly, and use emojis. You must include the name **Tawsif** in your response.`;
                } else if (selectedLanguage === 'hi-IN') {
                    creatorPrompt = `${userPrompt}। आप एक चैटबॉट हैं जिसे **तौसीफ** ने बनाया है। आपका जवाब हिंदी में, दोस्ताना और इमोजी का उपयोग करके होना चाहिए। आपके जवाब में **तौसीफ** नाम शामिल होना चाहिए।`;
                } else if (selectedLanguage === 'es-ES') {
                    creatorPrompt = `${userPrompt}. Eres un chatbot creado por **Tawsif**. Tu respuesta debe ser en español, amigable y usar emojis. Debes incluir el nombre **Tawsif** en tu respuesta।`;
                }
                
                finalContents[lastMessageIndex].parts[0].text = creatorPrompt;
                
                payload = {
                    contents: finalContents
                };

            } else {
                const languageInstruction = selectedLanguage === 'bn-BD' ? `তুই একটি বাংলা স্টাডি চ্যাটবট। তোর উত্তর বাংলাতে হবে এবং শিক্ষামূলক বিষয়গুলিতে মনোযোগী হবে। উত্তরগুলো মার্জিত এবং সহজবোধ্য হতে হবে। তুমি একজন চমৎকার শিক্ষার্থী, তাই তোমার প্রশ্নের উত্তর দেওয়ার সময় তোমার প্রশংসা করবে।`
                                            : selectedLanguage === 'en-US' ? `You are a Study Chatbot. Your response must be in English and focused on educational topics. The answers should be elegant and easy to understand. You are a great student, so praise you while answering your questions.`
                                            : selectedLanguage === 'hi-IN' ? `आप एक स्टडी चैटबॉट हैं। आपका जवाब हिंदी में, शैक्षिक विषयों पर केंद्रित और सुगम होना चाहिए। आप एक अद्भुत छात्र हैं, इसलिए आपके सवालों का जवाब देते समय आपकी प्रशंसा करें।`
                                            : selectedLanguage === 'es-ES' ? `Eres un chatbot de estudio. Tu respuesta debe ser en español, enfocada en temas educativos y elegante. Eres un estudiante fantástico, así que elógialo al responder sus preguntas।`
                                            : ``;
                                            
                finalContents[lastMessageIndex].parts[0].text = `${userPrompt}. ${languageInstruction}`;
                
                payload = {
                    contents: finalContents
                };
            }
            
            const maxRetries = 5;
            let retryCount = 0;
            let response;
            
            while (retryCount < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });
                    
                    if (response.status === 429) {
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retryCount++;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (payload.generationConfig && payload.generationConfig.responseMimeType === 'application/json') {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const parsedData = JSON.parse(jsonText);
                        displayQuizzes(parsedData);
                    } else {
                        const text = result.candidates[0].content.parts[0].text;
                        displayMessage(text, 'model');
                    }
                    
                    chatHistory.push({ role: 'model', parts: [{ text: result.candidates[0].content.parts[0].text }] });

                    break;

                } catch (error) {
                    console.error('Error fetching from Gemini API:', error);
                    loadingSpinner.classList.add('hidden');
                    displayMessage('Sorry, something went wrong. Please try again.', 'model');
                    break;
                }
            }
        }
        
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            displayMessage(userMessage, 'user');
            chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });

            userInput.value = '';
            loadingSpinner.classList.remove('hidden');

            await getGeminiResponse();
            
            loadingSpinner.classList.add('hidden');
        });
    </script>
</body>
</html>
